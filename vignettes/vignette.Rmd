---
title: "covid19Visualizer"
author: "Adrian Joseph"
output: html_document
---


```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = TRUE)
library('ff')
library('covid19Visualizer')
library('kableExtra')
library('DBI')
library('here')
```

# Introduction

Simple data visualizer for COVID-19 diffusion.

## Data

### Database

Data is provided by `Our world in data` and is obtained from <https://covid.ourworldindata.org/data/owid-covid-data.xlsx>.

New data is obtained with `updateDb()` (a network connection is required).

We can explore the database using the `rsqlite`/`DBI` package'

```{r exploreDb, warning=FALSE}
# connec to the database
con <- dbConnect(RSQLite::SQLite(), "testdb")

# get tables
dbListTables(con)

# get fields in a table
dbListFields(con, "events")

# close database connection
dbDisconnect(con)
```

## Work by country

```{r bycountry, warning=FALSE}
countries <- c('Canada', 'Italy')
population <- getPopulationDb(countries)
events <- getEventsDb(countries,
                    c('total_vaccinations',
                      'total_cases'))
eventsPlot(events, population, NULL, 1)
eventsPlot(events, population, 'population', 1e5)

```


## Work by groups of countries

```{r, bygroup, warning=FALSE}
groupsAre <- c('Africa', 'Europe')
groups <- getCountriesFromGroups(groupsAre)
countries <- unique(groups$Country)
population <- getPopulationDb(countries)
events <- getEventsDb(countries,
                    c('total_vaccinations',
                      'total_cases'))
events <- aggregateCountries(events, groups)
population <- aggregateCountries(population, groups)

eventsPlot(events, population, NULL, 1)
eventsPlot(events, population, 'population', 1e5)
```

### Plot population

This plot does not have y axis because metrics are normalised between 0 and 1 so that they can be visualised even when massively different (i.e. population and age). 
It is advised to display the plot using plotly: `ggplotly(p, tooltip = 'text')` to get more information from the tooltip.

```{r plotPopulation, warning=FALSE}
countries <- c('Canada', 'Italy')
population <- getPopulationDb(countries)
events <- getEventsDb(countries,
                    c('total_vaccinations',
                      'total_cases'))
populationPlot(population,
                    c('aged_65_older',
                      'aged_70_older',
                      'population'))

#ggplotly(p, tooltip = 'text')
```


## Maps

```{r maps, warning=FALSE}
countries <- NULL
normBy <- NULL
metric <- 'total_cases'
date <- '2021-01-31'
multiplyFactor <- 100
events <- getEventsMapDb(countries,
                         metric,
                         date,
                         normBy,
                         multiplyFactor)
doMap(events, FALSE)

countries <- c('Canada', 'Italy')
events <- getEventsMapDb(countries,
                         metric,
                         date,
                         normBy,
                         multiplyFactor)
doMap(events, TRUE)
```

Last update `r Sys.Date()`.
